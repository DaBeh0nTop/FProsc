<!doctype html>
<html lang="en">
<head>
Â  <meta charset="utf-8" />
Â  <meta name="viewport" content="width=device-width,initial-scale=1" />
Â  <title>ğŸ“š Classwork & To-Do Reminder</title>

Â  Â  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">

Â  Â  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

Â  Â  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
Â  <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>

Â  <style>
Â  Â  /************************************************************
Â  Â  * Root theme variables
Â  Â  ************************************************************/
Â  Â  :root {
Â  Â  Â  --bg1:#9FB3DF;Â 
Â  Â  Â  --bg2:#9EC6F3;Â 
Â  Â  Â  --bg3:#A8E6CF;Â 
Â  Â  Â  --bg4:#FFD3B6;Â 
Â  Â  Â  --bg5:#FFAAA5;
Â  Â  Â  --panel:rgba(255,255,255,0.12);Â 
Â  Â  Â  --accent:#FFF1D5;Â 
Â  Â  Â  --danger:#ff6961;
Â  Â  Â  --text-dark:#1a1a1a;Â 
Â  Â  Â  --success:#66ffb2;Â 
Â  Â  Â  --uploading:#ffe066;
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Base
Â  Â  ************************************************************/
Â  Â  * {Â 
Â  Â  Â  box-sizing:border-box;Â 
Â  Â  Â  margin:0;Â 
Â  Â  Â  padding:0;Â 
Â  Â  }
Â  Â  body {
Â  Â  Â  font-family:'Poppins',sans-serif;Â 
Â  Â  Â  min-height:100vh;
Â  Â  Â  display:flex;Â 
Â  Â  Â  flex-direction:column;Â 
Â  Â  Â  align-items:center;
Â  Â  Â  padding:20px;Â 
Â  Â  Â  color:#fff;
Â  Â  Â  background:linear-gradient(135deg,var(--bg1),var(--bg2),var(--bg3),var(--bg4),var(--bg5));
Â  Â  Â  background-size:600% 600%;Â 
Â  Â  Â  animation:bgMove 18s ease infinite;
Â  Â  }

Â  Â  @keyframes bgMove {Â 
Â  Â  Â  0%{background-position:0% 50%}Â 
Â  Â  Â  50%{background-position:100% 50%}Â 
Â  Â  Â  100%{background-position:0% 50%}Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Header
Â  Â  ************************************************************/
Â  Â  header {Â 
Â  Â  Â  text-align:center;Â 
Â  Â  Â  margin-bottom:20px;Â 
Â  Â  Â  width:100%;Â 
Â  Â  }
Â  Â  header h1 {Â 
Â  Â  Â  font-size:30px;Â 
Â  Â  Â  font-weight:700;Â 
Â  Â  Â  text-shadow:1px 2px 8px rgba(0,0,0,0.3);Â 
Â  Â  }
Â  Â  header h2 {Â 
Â  Â  Â  font-size:14px;Â 
Â  Â  Â  margin-top:6px;Â 
Â  Â  Â  font-weight:400;Â 
Â  Â  Â  opacity:0.85;Â 
Â  Â  Â  animation:fade 2s infinite alternate;Â 
Â  Â  }
Â  Â  @keyframes fade {Â 
Â  Â  Â  from{opacity:0.6}Â 
Â  Â  Â  to{opacity:1}Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Panels
Â  Â  ************************************************************/
Â  Â  .container {Â 
Â  Â  Â  width:100%;Â 
Â  Â  Â  max-width:900px;Â 
Â  Â  }
Â  Â  .panel {
Â  Â  Â  background:var(--panel);Â 
Â  Â  Â  border-radius:16px;Â 
Â  Â  Â  padding:18px;Â 
Â  Â  Â  margin-bottom:20px;
Â  Â  Â  backdrop-filter:blur(10px);Â 
Â  Â  Â  box-shadow:0 8px 18px rgba(0,0,0,0.25);Â 
Â  Â  Â  transition:transform .2s;
Â  Â  }
Â  Â  .panel:hover {Â 
Â  Â  Â  transform:translateY(-3px);Â 
Â  Â  }
Â  Â  .small {Â 
Â  Â  Â  font-size:13px;Â 
Â  Â  Â  opacity:0.9;Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * List Items
Â  Â  ************************************************************/
Â  Â  ul.plain {Â 
Â  Â  Â  list-style:none;Â 
Â  Â  Â  margin:12px 0;Â 
Â  Â  Â  padding:0;Â 
Â  Â  }
Â  Â  li.item {
Â  Â  Â  background:rgba(255,255,255,0.08);Â 
Â  Â  Â  border-radius:10px;Â 
Â  Â  Â  padding:12px 14px;Â 
Â  Â  Â  margin-bottom:10px;
Â  Â  Â  display:flex;Â 
Â  Â  Â  flex-direction:column;Â 
Â  Â  Â  cursor:pointer;Â 
Â  Â  Â  transition:background .25s,transform .25s;Â 
Â  Â  Â  position:relative;
Â  Â  }
Â  Â  li.item:hover {Â 
Â  Â  Â  background:rgba(255,255,255,0.18);Â 
Â  Â  Â  transform:scale(1.01);Â 
Â  Â  }
Â  Â  .subject-line {Â 
Â  Â  Â  font-weight:600;Â 
Â  Â  Â  font-size:15px;Â 
Â  Â  Â  padding-right:96px; /* space for buttons */
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Image summary (tiny thumbnails)
Â  Â  ************************************************************/
Â  Â  .image-summary {Â 
Â  Â  Â  display:flex;Â 
Â  Â  Â  gap:6px;Â 
Â  Â  Â  margin-top:6px;Â 
Â  Â  Â  flex-wrap:wrap;Â 
Â  Â  }
Â  Â  .image-summary img {Â 
Â  Â  Â  width:46px;Â 
Â  Â  Â  height:36px;Â 
Â  Â  Â  object-fit:cover;Â 
Â  Â  Â  border-radius:4px;Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Expanded images row
Â  Â  ************************************************************/
Â  Â  .images-row {Â 
Â  Â  Â  display:none;Â 
Â  Â  Â  gap:8px;Â 
Â  Â  Â  margin-top:8px;Â 
Â  Â  Â  flex-wrap:wrap;Â 
Â  Â  }
Â  Â  .image-wrapper {Â 
Â  Â  Â  position:relative;Â 
Â  Â  Â  display:inline-block;Â 
Â  Â  }
Â  Â  .images-row img {
Â  Â  Â  width:84px;Â 
Â  Â  Â  height:64px;Â 
Â  Â  Â  object-fit:cover;Â 
Â  Â  Â  border-radius:6px;
Â  Â  Â  cursor:pointer;Â 
Â  Â  Â  transition:transform .2s;
Â  Â  }
Â  Â  .images-row img:hover {Â 
Â  Â  Â  transform:scale(1.05);Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Buttons
Â  Â  ************************************************************/
Â  Â  .btn {Â 
Â  Â  Â  background:var(--accent);Â 
Â  Â  Â  color:var(--text-dark);Â 
Â  Â  Â  border:none;Â 
Â  Â  Â  border-radius:8px;Â 
Â  Â  Â  padding:8px 14px;Â 
Â  Â  Â  font-weight:600;Â 
Â  Â  Â  cursor:pointer;Â 
Â  Â  Â  margin-top:6px;Â 
Â  Â  }
Â  Â  .btn-danger {Â 
Â  Â  Â  background:var(--danger);Â 
Â  Â  Â  color:#fff;Â 
Â  Â  Â  font-size:12px;Â 
Â  Â  Â  padding:4px 8px;Â 
Â  Â  Â  border-radius:6px;Â 
Â  Â  Â  position:absolute;Â 
Â  Â  Â  right:8px;Â 
Â  Â  Â  top:8px;Â 
Â  Â  }

Â  Â  /* New: Download-all button */
Â  Â  .btn-download-all {Â 
Â  Â  Â  background:rgba(0,0,0,0.6);Â 
Â  Â  Â  color:#fff;Â 
Â  Â  Â  font-size:12px;Â 
Â  Â  Â  padding:4px 8px;Â 
Â  Â  Â  border-radius:6px;Â 
Â  Â  Â  position:absolute;Â 
Â  Â  Â  right:44px;Â 
Â  Â  Â  top:8px;
Â  Â  Â  border:none;
Â  Â  Â  cursor:pointer;
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Inputs
Â  Â  ************************************************************/
Â  Â  input, textarea {Â 
Â  Â  Â  width:100%;Â 
Â  Â  Â  padding:10px;Â 
Â  Â  Â  margin-top:6px;Â 
Â  Â  Â  border:none;Â 
Â  Â  Â  border-radius:10px;Â 
Â  Â  Â  background:rgba(255,255,255,0.08);Â 
Â  Â  Â  color:#fff;Â 
Â  Â  Â  font-size:14px;Â 
Â  Â  }
Â  Â  textarea {Â 
Â  Â  Â  min-height:70px;Â 
Â  Â  Â  resize:vertical;Â 
Â  Â  }

Â  Â  .file-input {Â 
Â  Â  Â  display:inline-block;Â 
Â  Â  Â  padding:8px 12px;Â 
Â  Â  Â  border-radius:10px;Â 
Â  Â  Â  background:rgba(255,255,255,0.18);Â 
Â  Â  Â  margin-top:8px;Â 
Â  Â  Â  cursor:pointer;Â 
Â  Â  Â  font-size:14px;Â 
Â  Â  }
Â  Â  .file-input input {Â 
Â  Â  Â  display:none;Â 
Â  Â  }
Â  Â  .file-count {Â 
Â  Â  Â  font-size:12px;Â 
Â  Â  Â  opacity:0.8;Â 
Â  Â  Â  margin-top:4px;Â 
Â  Â  }

Â  Â  .uploading {Â 
Â  Â  Â  margin-top:6px;Â 
Â  Â  Â  font-size:13px;Â 
Â  Â  Â  color:var(--uploading);Â 
Â  Â  Â  animation:blink 1.2s infinite;Â 
Â  Â  }
Â  Â  @keyframes blink {Â 
Â  Â  Â  0%,100% { opacity:0.6; }Â 
Â  Â  Â  50% { opacity:1 }Â 
Â  Â  }

Â  Â  pre {Â 
Â  Â  Â  white-space:pre-wrap;Â 
Â  Â  Â  max-height:250px;Â 
Â  Â  Â  overflow:auto;Â 
Â  Â  Â  font-size:12px;Â 
Â  Â  Â  background:rgba(0,0,0,0.3);Â 
Â  Â  Â  padding:8px;Â 
Â  Â  Â  border-radius:8px;Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Admin toggle (bottom right)
Â  Â  ************************************************************/
Â  Â  #adminToggle {
Â  Â  Â  position:fixed;Â 
Â  Â  Â  bottom:20px;Â 
Â  Â  Â  right:20px;
Â  Â  Â  background:var(--accent);Â 
Â  Â  Â  color:var(--text-dark);
Â  Â  Â  border:none;Â 
Â  Â  Â  border-radius:10px;Â 
Â  Â  Â  padding:8px 14px;Â 
Â  Â  Â  font-weight:600;Â 
Â  Â  Â  cursor:pointer;
Â  Â  Â  box-shadow:0 4px 10px rgba(0,0,0,0.25);Â 
Â  Â  Â  transition:transform .2s;
Â  Â  }
Â  Â  #adminToggle:hover {Â 
Â  Â  Â  transform:scale(1.05);Â 
Â  Â  }
Â  Â  #logoutBtn {Â 
Â  Â  Â  display:none;Â 
Â  Â  }

Â  Â  .hidden {Â 
Â  Â  Â  display:none!important;Â 
Â  Â  }

Â  Â  @media(max-width:600px){
Â  Â  Â  .images-row img {Â 
Â  Â  Â  Â  width:48%;Â 
Â  Â  Â  Â  height:100px;Â 
Â  Â  Â  }
Â  Â  }
Â  </style>
</head>
<body>
Â  <header>
Â  Â  <h1>GALILEANS REMINDER</h1>
Â  Â  <h2>Made by Bisayang Dabeh</h2>
Â  </header>

Â  <main class="container">
Â  Â  Â  Â  <section class="panel" id="subjectsPanel">
Â  Â  Â  <div style="display:flex;justify-content:space-between;align-items:center;">
Â  Â  Â  Â  <div>
Â  Â  Â  Â  Â  <div style="font-size:14px;opacity:0.9">SUBJECTS NEED TO DO</div>
Â  Â  Â  Â  Â  <div class="small">Click subject to view details</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="small" id="subjectsCount">0</div>
Â  Â  Â  </div>
Â  Â  Â  <ul id="subjectsList" class="plain"></ul>
Â  Â  </section>

Â  Â  Â  Â  <section class="panel" id="remindersPanel">
Â  Â  Â  <div style="font-size:14px;opacity:0.9;margin-bottom:4px">EXTRA / REMINDERS</div>
Â  Â  Â  <ul id="remindersList" class="plain"></ul>
Â  Â  </section>

Â  Â  Â  Â  <section class="panel hidden" id="loginPanel">
Â  Â  Â  <div id="loginForm">
Â  Â  Â  Â  <div style="font-weight:600;margin-bottom:8px">ğŸ”‘ Admin Login</div>
Â  Â  Â  Â  <input id="email" type="email" placeholder="admin email" />
Â  Â  Â  Â  <input id="password" type="password" placeholder="password" />
Â  Â  Â  Â  <button class="btn" id="loginBtn" style="margin-top:10px">Login as Admin</button>
Â  Â  Â  Â  <div class="small" id="loginStatus"></div>
Â  Â  Â  </div>
Â  Â  Â  <div id="adminPanel" class="hidden" style="margin-top:16px">
Â  Â  Â  Â  <div style="font-weight:700;margin-bottom:8px">âš™ï¸ Admin Panel</div>
Â  Â  Â  Â  Â  Â  Â  Â  <form id="addSubjectForm">
Â  Â  Â  Â  Â  <input id="subjectName" type="text" placeholder="Subject e.g. SCIENCE" required />
Â  Â  Â  Â  Â  <input id="subjectTask" type="text" placeholder="Task e.g. NOTES" required />
Â  Â  Â  Â  Â  <input id="subjectDue" type="text" placeholder="Due (TOM, Tuesday)" />
Â  Â  Â  Â  Â  <label class="file-input">ğŸ“· Upload Images <input id="subjectFiles" type="file" multiple accept="image/*" /></label>
Â  Â  Â  Â  Â  <div class="file-count" id="subjectFileCount"></div>
Â  Â  Â  Â  Â  <button class="btn" type="submit" style="margin-top:8px">â• Add Subject</button>
Â  Â  Â  Â  Â  <div class="small" id="subjectFormMsg"></div>
Â  Â  Â  Â  </form>
Â  Â  Â  Â  <hr style="margin:14px 0;opacity:0.2" />
Â  Â  Â  Â  Â  Â  Â  Â  <form id="addReminderForm">
Â  Â  Â  Â  Â  <textarea id="reminderText" placeholder="Reminder text..." required></textarea>
Â  Â  Â  Â  Â  <label class="file-input">ğŸ“· Upload Images <input id="reminderFiles" type="file" multiple accept="image/*" /></label>
Â  Â  Â  Â  Â  <div class="file-count" id="reminderFileCount"></div>
Â  Â  Â  Â  Â  <button class="btn" type="submit" style="margin-top:8px">â• Add Reminder</button>
Â  Â  Â  Â  Â  <div class="small" id="reminderFormMsg"></div>
Â  Â  Â  Â  </form>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  Â  Â  <section class="panel" id="debugPanel">
Â  Â  Â  <div style="font-weight:600;margin-bottom:6px">Debug / Status</div>
Â  Â  Â  <pre id="debugLog"></pre>
Â  Â  </section>
Â  </main>

Â  Â  <button id="adminToggle">ğŸ”‘ ADMIN</button>
Â  <button class="hidden" id="logoutBtn" onclick="logout()">Logout</button>

Â  <script>
Â  Â  /************************************************************
Â  Â  * Supabase Init
Â  Â  ************************************************************/
Â  Â  const SUPABASE_URL = "https://mwosezbzzxjzpgxsdpdr.supabase.co";
Â  Â  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im13b3NlemJ6enhqenBneHNkcGRyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTgwMjk5ODQsImV4cCI6MjA3MzYwNTk4NH0.LzE9RoKMx9zsMdqydL1vSNeUCNlpD2izQMNCrqiAeCk";
Â  Â  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

Â  Â  // Use your existing public bucket
Â  Â  const STORAGE_BUCKET = "uploads";Â 

Â  Â  // A. Constants (near your other constants)
Â  Â  const ADMIN_EMAIL = "adminv2@gmail.com";

Â  Â  /************************************************************
Â  Â  * DOM References
Â  Â  ************************************************************/
Â  Â  const subjectsList=document.getElementById('subjectsList');
Â  Â  const remindersList=document.getElementById('remindersList');
Â  Â  const subjectsCount=document.getElementById('subjectsCount');
Â  Â  const loginPanel=document.getElementById('loginPanel');
Â  Â  const loginBtn=document.getElementById('loginBtn');
Â  Â  const loginStatus=document.getElementById('loginStatus');
Â  Â  const adminPanel=document.getElementById('adminPanel');
Â  Â  const logoutBtn=document.getElementById('logoutBtn');
Â  Â  const subjectFormMsg=document.getElementById('subjectFormMsg');
Â  Â  const reminderFormMsg=document.getElementById('reminderFormMsg');
Â  Â  const debugLog=document.getElementById('debugLog');
Â  Â  const adminToggle=document.getElementById('adminToggle');
Â  Â  const subjectFileCount=document.getElementById('subjectFileCount');
Â  Â  const reminderFileCount=document.getElementById('reminderFileCount');

Â  Â  // Form inputs
Â  Â  const addSubjectForm = document.getElementById('addSubjectForm');
Â  Â  const subjectName = document.getElementById('subjectName');
Â  Â  const subjectTask = document.getElementById('subjectTask');
Â  Â  const subjectDueÂ  = document.getElementById('subjectDue');
Â  Â  const subjectFilesEl = document.getElementById('subjectFiles');

Â  Â  const addReminderForm = document.getElementById('addReminderForm');
Â  Â  const reminderText = document.getElementById('reminderText');
Â  Â  const reminderFilesEl = document.getElementById('reminderFiles');

Â  Â  let isAdmin=false;

Â  Â  /************************************************************
Â  Â  * Utilities
Â  Â  ************************************************************/
Â  Â  function logFixed(msg) {
Â  Â  Â  const fixed = msg || "Loading subjects + reminders... Render complete.";
Â  Â  Â  debugLog.textContent=fixed;
Â  Â  }
Â  Â  function toggleLogin(){Â 
Â  Â  Â  loginPanel.classList.toggle('hidden');Â 
Â  Â  }
Â  Â  adminToggle.onclick=()=> toggleLogin();

Â  Â  // simple uid for file paths
Â  Â  const uid = () => Math.random().toString(36).slice(2) + Date.now();

Â  Â  // upload helper -> returns array of public URLs (no compression)
Â  Â  async function uploadFilesReturnUrls(inputEl, subfolder) {
Â  Â  Â  const files = Array.from(inputEl?.files || []);
Â  Â  Â  if (!files.length) return [];
Â  Â  Â  for (const f of files) {
Â  Â  Â  Â  const path = `${subfolder}/${uid()}-${f.name}`;
Â  Â  Â  Â  const { error: upErr } = await supabase.storage
Â  Â  Â  Â  Â  .from(STORAGE_BUCKET)
Â  Â  Â  Â  Â  .upload(path, f, { cacheControl: '3600', upsert: false, contentType: f.type || 'application/octet-stream' });
Â  Â  Â  Â  if (upErr) throw upErr;
Â  Â  Â  Â  const { data } = supabase.storage.from(STORAGE_BUCKET).getPublicUrl(path);
Â  Â  Â  Â  urls.push(data.publicUrl);
Â  Â  Â  }
Â  Â  Â  return urls;
Â  Â  }

Â  Â  // CORS-safe fetch â†’ Blob (for forced download)
Â  Â  async function fetchAsBlob(url) {
Â  Â  Â  const res = await fetch(url, { mode: 'cors' });
Â  Â  Â  if (!res.ok) throw new Error(`Fetch failed: ${res.status}`);
Â  Â  Â  return await res.blob();
Â  Â  }

Â  Â  // Download All (ZIP if multiple, direct save if single)
Â  Â  async function downloadAll(label, urls) {
Â  Â  Â  if (!urls || !urls.length) return;
Â  Â  Â  // Single image â†’ save directly (prevents opening new tab)
Â  Â  Â  if (urls.length === 1) {
Â  Â  Â  Â  const blob = await fetchAsBlob(urls[0]);
Â  Â  Â  Â  const ext = (urls[0].split('.').pop() || 'jpg').split('?')[0];
Â  Â  Â  Â  saveAs(blob, `${(label||'image').replace(/[^a-z0-9-_]/gi,'_')}.${ext}`);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  // Multiple â†’ ZIP
Â  Â  Â  const zip = new JSZip();
Â  Â  Â  const folder = zip.folder((label || 'images').replace(/[^a-z0-9-_]/gi,'_')) || zip;
Â  Â  Â  let i = 1;
Â  Â  Â  for (const url of urls) {
Â  Â  Â  Â  const blob = await fetchAsBlob(url);
Â  Â  Â  Â  const ext = (url.split('.').pop() || 'jpg').split('?')[0];
Â  Â  Â  Â  folder.file(`img_${i}.${ext}`, blob);
Â  Â  Â  Â  i++;
Â  Â  Â  }
Â  Â  Â  const content = await zip.generateAsync({ type: 'blob' });
Â  Â  Â  saveAs(content, `${(label || 'images').replace(/[^a-z0-9-_]/gi,'_')}.zip`);
Â  Â  }

Â  Â  // file counters
Â  Â  subjectFilesEl?.addEventListener('change', () => {
Â  Â  Â  subjectFileCount.textContent = subjectFilesEl.files.length
Â  Â  Â  Â  ? `${subjectFilesEl.files.length} image(s) selected` : '';
Â  Â  });
Â  Â  reminderFilesEl?.addEventListener('change', () => {
Â  Â  Â  reminderFileCount.textContent = reminderFilesEl.files.length
Â  Â  Â  Â  ? `${reminderFilesEl.files.length} image(s) selected` : '';
Â  Â  });

Â  Â  // B. Visitor logger (call once on load)
Â  Â  async function logVisitorOnce(){
Â  Â  Â  try{
Â  Â  Â  Â  const key = 'vis_logged_at_v3';
Â  Â  Â  Â  const last = Number(localStorage.getItem(key) || 0);
Â  Â  Â  Â  const nowÂ  = Date.now();
Â  Â  Â  Â  // Log visitor no more than once every 6 hours
Â  Â  Â  Â  if (now - last < 6*60*60*1000) return;

Â  Â  Â  Â  let info = null;

Â  Â  Â  Â  // Try ipapi.co first
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  const r = await fetch('https://ipapi.co/json/');
Â  Â  Â  Â  Â  if (r.ok) info = await r.json();
Â  Â  Â  Â  }catch(_){}

Â  Â  Â  Â  // Fallback to ipwho.is if ipapi.co fails
Â  Â  Â  Â  if (!info) {
Â  Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  Â  const r2 = await fetch('https://ipwho.is/');
Â  Â  Â  Â  Â  Â  // ipwho.is returns { success: false } on error, so check is only for response.ok
Â  Â  Â  Â  Â  Â  if (r2.ok) info = await r2.json();
Â  Â  Â  Â  Â  }catch(_){}
Â  Â  Â  Â  }
Â  Â  Â  Â  if (!info) return;

Â  Â  Â  Â  // Normalize data structure for Supabase insert
Â  Â  Â  Â  const row = {
Â  Â  Â  Â  Â  ip: info.ip || info.query || null,
Â  Â  Â  Â  Â  hostname: info.hostname || null,
Â  Â  Â  Â  Â  city: info.city || null,
Â  Â  Â  Â  Â  region: info.region || info.region_name || null,
Â  Â  Â  Â  Â  country: info.country_name || info.country || null,
Â  Â  Â  Â  Â  org: info.org || info.isp || (info.connection && info.connection.org) || null,
Â  Â  Â  Â  Â  asn: (info.asn || (info.connection && info.connection.asn)) ? String(info.asn || info.connection.asn) : null,
Â  Â  Â  Â  Â  ua: navigator.userAgent || null,
Â  Â  Â  Â  Â  referrer: document.referrer || null,
Â  Â  Â  Â  Â  page: location.pathname || "/",
Â  Â  Â  Â  Â  raw: info
Â  Â  Â  Â  };

Â  Â  Â  Â  const { error } = await supabase.from('visitor_logs').insert([row]);
Â  Â  Â  Â  if (!error) localStorage.setItem(key, String(now));
Â  Â  Â  }catch(_){}
Â  Â  }

Â  Â  // C. Admin audit helper
Â  Â  async function insertAudit(action, details){
Â  Â  Â  try{
Â  Â  Â  Â  const { data: u } = await supabase.auth.getUser();
Â  Â  Â  Â  const adminEmail = u?.user?.email || ADMIN_EMAIL || null;

Â  Â  Â  Â  let ip = null;
Â  Â  Â  Â  try{
Â  Â  Â  Â  Â  // Use a lightweight service just for IP
Â  Â  Â  Â  Â  const r = await fetch('https://api.ipify.org?format=json');
Â  Â  Â  Â  Â  if (r.ok){ const j = await r.json(); ip = j.ip || null; }
Â  Â  Â  Â  }catch(_){}

Â  Â  Â  Â  await supabase.from('audit_logs').insert([{
Â  Â  Â  Â  Â  admin_email: adminEmail,
Â  Â  Â  Â  Â  ip,
Â  Â  Â  Â  Â  user_agent: navigator.userAgent || null,
Â  Â  Â  Â  Â  action,
Â  Â  Â  Â  Â  details: details || {}
Â  Â  Â  Â  }]);
Â  Â  Â  }catch(_){}
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Data Load
Â  Â  ************************************************************/
Â  Â  async function loadData(){
Â  Â  Â  subjectsList.innerHTML='';Â 
Â  Â  Â  remindersList.innerHTML='';
Â  Â  Â  logFixed();

Â  Â  Â  // ---- SUBJECTS ----
Â  Â  Â  const { data: subjects, error: subjErr } = await supabase.from('subjects').select('*').order('id');
Â  Â  Â  if (subjErr) {
Â  Â  Â  Â  logFixed(`Subjects load error: ${subjErr.message}`);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  subjectsCount.textContent = subjects?.length || 0;

Â  Â  Â  subjects?.forEach(s=>{
Â  Â  Â  Â  const li=document.createElement('li');Â 
Â  Â  Â  Â  li.className='item';

Â  Â  Â  Â  // Download-all button for this subject
Â  Â  Â  Â  if (s.images && s.images.length) {
Â  Â  Â  Â  Â  const dlAll = document.createElement('button');
Â  Â  Â  Â  Â  dlAll.className = 'btn-download-all';
Â  Â  Â  Â  Â  dlAll.textContent = 'â¬‡ All';
Â  Â  Â  Â  Â  dlAll.title = 'Download all images';
Â  Â  Â  Â  Â  dlAll.onclick = async (e) => {Â 
Â  Â  Â  Â  Â  Â  e.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  dlAll.disabled = true;Â 
Â  Â  Â  Â  Â  Â  try { await downloadAll(s.name || 'subject', s.images); }
Â  Â  Â  Â  Â  Â  finally { dlAll.disabled = false; }
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  li.appendChild(dlAll);
Â  Â  Â  Â  }

Â  Â  Â  Â  const line=document.createElement('div');Â 
Â  Â  Â  Â  line.className='subject-line';
Â  Â  Â  Â  line.textContent=`${s.name} [ ${s.task} | ${s.due || 'TBA'} ]`;
Â  Â  Â  Â  li.appendChild(line);

Â  Â  Â  Â  // image summary (first 3 thumbs)
Â  Â  Â  Â  if(s.images&&s.images.length){
Â  Â  Â  Â  Â  const summary=document.createElement('div');
Â  Â  Â  Â  Â  summary.className='image-summary';
Â  Â  Â  Â  Â  s.images.slice(0,3).forEach(url=>{
Â  Â  Â  Â  Â  Â  const img=document.createElement('img');Â 
Â  Â  Â  Â  Â  Â  img.src=url;
Â  Â  Â  Â  Â  Â  summary.appendChild(img);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  li.appendChild(summary);
Â  Â  Â  Â  }

Â  Â  Â  Â  // expanded images row
Â  Â  Â  Â  const imgRow=document.createElement('div');Â 
Â  Â  Â  Â  imgRow.className='images-row';
Â  Â  Â  Â  if(s.images&&s.images.length){
Â  Â  Â  Â  Â  s.images.forEach(url=>{
Â  Â  Â  Â  Â  Â  const wrap=document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  wrap.className='image-wrapper';
Â  Â  Â  Â  Â  Â  const img=document.createElement('img');Â 
Â  Â  Â  Â  Â  Â  img.src=url;
Â  Â  Â  Â  Â  Â  wrap.appendChild(img);
Â  Â  Â  Â  Â  Â  imgRow.appendChild(wrap);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  li.appendChild(imgRow);
Â  Â  Â  Â  li.onclick=()=> imgRow.style.display=imgRow.style.display==='flex'?'none':'flex';

Â  Â  Â  Â  if(isAdmin){
Â  Â  Â  Â  Â  const del=document.createElement('button');Â 
Â  Â  Â  Â  Â  del.className='btn-danger';Â 
Â  Â  Â  Â  Â  del.textContent='âœ–';
Â  Â  Â  Â  Â  del.onclick=async(e)=>{Â 
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  await insertAudit('DELETE_SUBJECT', { subject_id: s.id, name: s.name });
Â  Â  Â  Â  Â  Â  await deleteSubject(s.id);Â 
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  li.appendChild(del);
Â  Â  Â  Â  }
Â  Â  Â  Â  subjectsList.appendChild(li);
Â  Â  Â  });

Â  Â  Â  // ---- REMINDERS ----
Â  Â  Â  const { data: reminders, error: remErr } = await supabase.from('reminders').select('*').order('id');
Â  Â  Â  if (remErr) {
Â  Â  Â  Â  logFixed(`Reminders load error: ${remErr.message}`);
Â  Â  Â  Â  return;
Â  Â  Â  }
Â  Â  Â  reminders?.forEach(r=>{
Â  Â  Â  Â  const li=document.createElement('li');Â 
Â  Â  Â  Â  li.className='item';

Â  Â  Â  Â  // Download-all button for this reminder
Â  Â  Â  Â  if (r.images && r.images.length) {
Â  Â  Â  Â  Â  const dlAll = document.createElement('button');
Â  Â  Â  Â  Â  dlAll.className = 'btn-download-all';
Â  Â  Â  Â  Â  dlAll.textContent = 'â¬‡ All';
Â  Â  Â  Â  Â  dlAll.title = 'Download all images';
Â  Â  Â  Â  Â  dlAll.onclick = async (e) => {Â 
Â  Â  Â  Â  Â  Â  e.stopPropagation();Â 
Â  Â  Â  Â  Â  Â  dlAll.disabled = true;Â 
Â  Â  Â  Â  Â  Â  try { await downloadAll('reminder', r.images); }
Â  Â  Â  Â  Â  Â  finally { dlAll.disabled = false; }
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  li.appendChild(dlAll);
Â  Â  Â  Â  }

Â  Â  Â  Â  const line=document.createElement('div');Â 
Â  Â  Â  Â  line.className='subject-line';Â 
Â  Â  Â  Â  line.textContent=r.text;
Â  Â  Â  Â  li.appendChild(line);

Â  Â  Â  Â  if(r.images&&r.images.length){
Â  Â  Â  Â  Â  const summary=document.createElement('div');Â 
Â  Â  Â  Â  Â  summary.className='image-summary';
Â  Â  Â  Â  Â  r.images.slice(0,3).forEach(url=>{
Â  Â  Â  Â  Â  Â  const img=document.createElement('img');Â 
Â  Â  Â  Â  Â  Â  img.src=url;
Â  Â  Â  Â  Â  Â  summary.appendChild(img);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  li.appendChild(summary);
Â  Â  Â  Â  }

Â  Â  Â  Â  const imgRow=document.createElement('div');Â 
Â  Â  Â  Â  imgRow.className='images-row';
Â  Â  Â  Â  if(r.images&&r.images.length){
Â  Â  Â  Â  Â  r.images.forEach(url=>{
Â  Â  Â  Â  Â  Â  const wrap=document.createElement('div');Â 
Â  Â  Â  Â  Â  Â  wrap.className='image-wrapper';
Â  Â  Â  Â  Â  Â  const img=document.createElement('img');Â 
Â  Â  Â  Â  Â  Â  img.src=url;
Â  Â  Â  Â  Â  Â  wrap.appendChild(img);
Â  Â  Â  Â  Â  Â  imgRow.appendChild(wrap);
Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  li.appendChild(imgRow);
Â  Â  Â  Â  li.onclick=()=> imgRow.style.display=imgRow.style.display==='flex'?'none':'flex';

Â  Â  Â  Â  if(isAdmin){
Â  Â  Â  Â  Â  const del=document.createElement('button');Â 
Â  Â  Â  Â  Â  del.className='btn-danger';Â 
Â  Â  Â  Â  Â  del.textContent='âœ–';
Â  Â  Â  Â  Â  del.onclick=async(e)=>{Â 
Â  Â  Â  Â  Â  Â  e.stopPropagation();
Â  Â  Â  Â  Â  Â  await insertAudit('DELETE_REMINDER', { reminder_id: r.id, text: r.text });
Â  Â  Â  Â  Â  Â  await deleteReminder(r.id);Â 
Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  li.appendChild(del);
Â  Â  Â  Â  }
Â  Â  Â  Â  remindersList.appendChild(li);
Â  Â  Â  });

Â  Â  Â  logFixed();
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Delete functions
Â  Â  ************************************************************/
Â  Â  async function deleteSubject(id){Â 
Â  Â  Â  const { error } = await supabase.from('subjects').delete().eq('id',id);Â 
Â  Â  Â  if (error) { logFixed(`Delete subject error: ${error.message}`); }
Â  Â  Â  await loadData();Â 
Â  Â  }
Â  Â  async function deleteReminder(id){Â 
Â  Â  Â  const { error } = await supabase.from('reminders').delete().eq('id',id);Â 
Â  Â  Â  if (error) { logFixed(`Delete reminder error: ${error.message}`); }
Â  Â  Â  await loadData();Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * Auth
Â  Â  ************************************************************/
Â  Â  loginBtn.onclick=async()=>{
Â  Â  Â  const email=document.getElementById('email').value;
Â  Â  Â  const pass=document.getElementById('password').value;
Â  Â  Â  loginStatus.textContent="Logging in...";
Â  Â  Â  const {data,error}=await supabase.auth.signInWithPassword({email,password:pass});
Â  Â  Â  if(error){Â 
Â  Â  Â  Â  loginStatus.textContent=error.message;Â 
Â  Â  Â  Â  return;Â 
Â  Â  Â  }
Â  Â  Â  loginStatus.textContent="Logged in âœ”";
Â  Â  Â  isAdmin=true;Â 
Â  Â  Â  adminPanel.classList.remove('hidden');Â 
Â  Â  Â  logoutBtn.classList.remove('hidden');
Â  Â  Â  adminToggle.textContent='âš™ï¸ PANEL';
Â  Â  Â  await insertAudit('ADMIN_LOGIN', { email }); // Log admin action
Â  Â  Â  loadData();
Â  Â  };
Â  Â  async function logout(){Â 
Â  Â  Â  await supabase.auth.signOut();Â 
Â  Â  Â  isAdmin=false;Â 
Â  Â  Â  adminPanel.classList.add('hidden');Â 
Â  Â  Â  logoutBtn.classList.add('hidden');Â 
Â  Â  Â  adminToggle.textContent='ğŸ”‘ ADMIN';
Â  Â  Â  await insertAudit('ADMIN_LOGOUT', {}); // Log admin action
Â  Â  Â  loadData();Â 
Â  Â  }

Â  Â  /************************************************************
Â  Â  * FORM HANDLERS (prevent reload, upload, insert, refresh UI)
Â  Â  ************************************************************/
Â  Â  addSubjectForm?.addEventListener('submit', async (e) => {
Â  Â  Â  e.preventDefault(); // STOP page reload
Â  Â  Â  subjectFormMsg.textContent = 'Uploading...';
Â  Â  Â  const btn = addSubjectForm.querySelector('button[type="submit"]');
Â  Â  Â  btn.disabled = true;

Â  Â  Â  try {
Â  Â  Â  Â  const imgUrls = await uploadFilesReturnUrls(subjectFilesEl, 'subjects');
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  name: subjectName.value.trim(),
Â  Â  Â  Â  Â  task: subjectTask.value.trim(),
Â  Â  Â  Â  Â  due:Â  subjectDue.value.trim(),
Â  Â  Â  Â  Â  images: imgUrls
Â  Â  Â  Â  };
Â  Â  Â  Â  if (!payload.name || !payload.task) {
Â  Â  Â  Â  Â  throw new Error('Name and Task are required.');
Â  Â  Â  Â  }
Â  Â  Â  Â  const { error } = await supabase.from('subjects').insert([payload]);
Â  Â  Â  Â  if (error) throw error;
Â  Â  Â  Â  
Â  Â  Â  Â  // Log admin action
Â  Â  Â  Â  await insertAudit('ADD_SUBJECT', payload);

Â  Â  Â  Â  addSubjectForm.reset();
Â  Â  Â  Â  subjectFileCount.textContent = '';
Â  Â  Â  Â  subjectFormMsg.textContent = 'Added âœ…';
Â  Â  Â  Â  await loadData();
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  subjectFormMsg.textContent = `Error: ${err.message || err}`;
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  setTimeout(()=> subjectFormMsg.textContent = '', 2500);
Â  Â  Â  }
Â  Â  });

Â  Â  addReminderForm?.addEventListener('submit', async (e) => {
Â  Â  Â  e.preventDefault(); // STOP page reload
Â  Â  Â  reminderFormMsg.textContent = 'Uploading...';
Â  Â  Â  const btn = addReminderForm.querySelector('button[type="submit"]');
Â  Â  Â  btn.disabled = true;

Â  Â  Â  try {
Â  Â  Â  Â  const imgUrls = await uploadFilesReturnUrls(reminderFilesEl, 'reminders');
Â  Â  Â  Â  const payload = {
Â  Â  Â  Â  Â  text: reminderText.value.trim(),
Â  Â  Â  Â  Â  images: imgUrls
Â  Â  Â  Â  };
Â  Â  Â  Â  if (!payload.text) {
Â  Â  Â  Â  Â  throw new Error('Reminder text is required.');
Â  Â  Â  Â  }
Â  Â  Â  Â  const { error } = await supabase.from('reminders').insert([payload]);
Â  Â  Â  Â  if (error) throw error;

Â  Â  Â  Â  // Log admin action
Â  Â  Â  Â  await insertAudit('ADD_REMINDER', payload);

Â  Â  Â  Â  addReminderForm.reset();
Â  Â  Â  Â  reminderFileCount.textContent = '';
Â  Â  Â  Â  reminderFormMsg.textContent = 'Added âœ…';
Â  Â  Â  Â  await loadData();
Â  Â  Â  } catch (err) {
Â  Â  Â  Â  reminderFormMsg.textContent = `Error: ${err.message || err}`;
Â  Â  Â  } finally {
Â  Â  Â  Â  btn.disabled = false;
Â  Â  Â  Â  setTimeout(()=> reminderFormMsg.textContent = '', 2500);
Â  Â  Â  }
Â  Â  });

Â  Â  /************************************************************
Â  Â  * Initial Load
Â  Â  ************************************************************/
Â  Â  logVisitorOnce(); // Call the visitor logger once on load
Â  Â  loadData();
Â  </script>
</body>
</html>
